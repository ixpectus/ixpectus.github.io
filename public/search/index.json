[{"content":"","href":"/posts/storage/","title":"storage"},{"content":"","href":"/posts/administrate/","title":"administrate"},{"content":"","href":"/posts/linux/tools/","title":"linux tools"},{"content":"","href":"/","title":"ixpectus notes"},{"content":"","href":"/tags/pg_file_settings/","title":"pg_file_settings"},{"content":"","href":"/tags/pg_reload_conf/","title":"pg_reload_conf"},{"content":"","href":"/tags/pg_settings/","title":"pg_settings"},{"content":"","href":"/tags/postgresql/","title":"postgresql"},{"content":"","href":"/posts/storage/postgresql/","title":"postgresql"},{"content":"","href":"/posts/","title":"posts"},{"content":"","href":"/tags/","title":"Tags"},{"content":" Демо Слайды  Посмотреть настройки конфигурационного файла Можно прямо в postgres, есть табличка, которая соответствует конфигурационному файлу\nselect * from pg_file_settings; sourcefile | sourceline | seqno | name | setting | applied | error --------------------------------------+------------+-------+----------------------------+--------------------+---------+-------- /usr/local/psql/data/postgresql.conf | 64 | 1 | max_connections | 100 | t | [NULL] /usr/local/psql/data/postgresql.conf | 113 | 2 | shared_buffers | 128MB | t | [NULL] /usr/local/psql/data/postgresql.conf | 127 | 3 | dynamic_shared_memory_type | posix | t | [NULL] /usr/local/psql/data/postgresql.conf | 461 | 4 | log_timezone | Europe/Moscow | t | [NULL] /usr/local/psql/data/postgresql.conf | 565 | 5 | datestyle | iso, mdy | t | [NULL] /usr/local/psql/data/postgresql.conf | 567 | 6 | timezone | Europe/Moscow | t | [NULL] /usr/local/psql/data/postgresql.conf | 580 | 7 | lc_messages | en_US.UTF-8 | t | [NULL] /usr/local/psql/data/postgresql.conf | 582 | 8 | lc_monetary | en_US.UTF-8 | t | [NULL] /usr/local/psql/data/postgresql.conf | 583 | 9 | lc_numeric | en_US.UTF-8 | t | [NULL] /usr/local/psql/data/postgresql.conf | 584 | 10 | lc_time | en_US.UTF-8 | t | [NULL] /usr/local/psql/data/postgresql.conf | 587 | 11 | default_text_search_config | pg_catalog.english | t | [NULL] (11 rows) Столбец applied везде установлен true, что говорит о том, что в конфигурационном файле значение установлено, но в текущей сессии вполне может быть другое значение этого параметра.\nГде посмотреть конфигурационные параметры текущей сессии  Посмотреть все текущие настройки(там много всего) select * from pg_settings;  Узнать имя текущего конфигурационного файла select * from pg_settings where name='config_file'; -[ RECORD 1 ]---+------------------------------------------- name | config_file setting | /usr/local/psql/data/postgresql.conf unit | [NULL] category | File Locations short_desc | Sets the server's main configuration file. extra_desc | [NULL] context | postmaster vartype | string source | override min_val | [NULL] max_val | [NULL] enumvals | [NULL] boot_val | [NULL] reset_val | /usr/local/psql/data/postgresql.conf sourcefile | [NULL] sourceline | [NULL] pending_restart | f Видим, что файл расположен в /usr/local/psql/data/postgresql.conf\n setting текущее значение параметра reset_val значение по умолчанию, если выполнить команду reset то оно будет установлено pending_restart обозначает необходимость перезапуска сервера для того, чтобы конфигурационный параметр применился(в нашей случае false, значит перезагружать сервер нет необходимости)   Узнать значение параметра work_mem - максимальное количество памяти, которое может быть выделено для текущего процесса  select * from pg_settings where name='work_mem'\\gx -[ RECORD 1 ]---+---------------------------------------------------------------------------------------------------------------------- name | work_mem setting | 4096 unit | kB category | Resource Usage / Memory short_desc | Sets the maximum memory to be used for query workspaces. extra_desc | This much memory can be used by each internal sort operation and hash table before switching to temporary disk files. context | user vartype | integer source | default min_val | 64 max_val | 2147483647 enumvals | [NULL] boot_val | 4096 reset_val | 4096 sourcefile | [NULL] sourceline | [NULL] pending_restart | f  setting текущее значение параметра unit единица измерения, в нашем случае kB reset_val если параметр изменен во время сеанса, то можно вызвать reset и будет установлено это значение pending_restart обозначает необходимость перезапуска сервера для того, чтобы конфигурационный параметр применился(в нашей случае false, значит перезагружать сервер нет необходимости) context установлен user, обозначает, что пользователь в рамках своей сессии может изменить значение дананого параметра boot_val значение по умолчанию min_val, max_val минимальное-максимальное значение параметра Параметр context  Можно посмотреть список возможных значений параметра context   select distinct context from pg_settings; context ------------------- postmaster superuser-backend user internal backend sighup superuser (7 rows)  internal изменить нельзя никогда user может изменить пользователь в рамках своей сессии postmaster нужен перезапуск сервера для изменения значения sighup требуется перечитать файлы конфигурации superuser суперпользователь может изменить для своего сеанса    Попробуем изменить значения параметра work_mem  Изменим значение в конфигурационном файле work_mem = 24MB  Посмотрим значения в отображении pg_file_settings 127.0.0.1 postgres@postgres=# select * from pg_file_settings where name='work_mem'; sourcefile | sourceline | seqno | name | setting | applied | error --------------------------------------+------------+-------+----------+---------+---------+-------- /usr/local/psql/data/postgresql.conf | 122 | 3 | work_mem | 24MB | t | [NULL] (1 row) Видим, что значение установлено\n Посмотрим значение в pg_settings 127.0.0.1 postgres@postgres=# select setting from pg_settings where name='work_mem'\\gx -[ RECORD 1 ]- setting | 4096 Значение не поменялось\n Для того, чтобы изменить значение нужно выполнить select pg_reload_conf();  Посмотрим на параметр 127.0.0.1 postgres@postgres=# select setting from pg_settings where name='work_mem'\\gx -[ RECORD 1 ]-- setting | 24576 Изменился!\n  Изменение параметров без ручной правки конфигурационного файла Есть команда ALTER SYSTEM, которая позволяет изменить значение параметра прямо в sql. Будет создан новый конфигурационный файл postgresql.auto.conf, значения параметров там будут перекрывать значения в postgresql.conf\n Изменим work_mem 127.0.0.1 postgres@postgres=# alter system set work_mem to '10MB'; ALTER SYSTEM Time: 5.099 ms  Смотрим, не изменилось 127.0.0.1 postgres@postgres=# select setting from pg_settings where name='work_mem'\\gx -[ RECORD 1 ]-- setting | 24576  Нужно обновить конфиги select pg_reload_conf и значение изменится alter system reset work_mem очистит значение  Изменение значений параметров на время сессии  SET work_mem to '26MB' Проверим, видим, что значение изменилось, и что источник session 127.0.0.1 postgres@postgres=# select * from pg_settings where name='work_mem'\\gx -[ RECORD 1 ]---+---------------------------------------------------------------------------------------------------------------------- name | work_mem setting | 26624 unit | kB category | Resource Usage / Memory short_desc | Sets the maximum memory to be used for query workspaces. extra_desc | This much memory can be used by each internal sort operation and hash table before switching to temporary disk files. context | user vartype | integer source | session   ","href":"/posts/storage/postgresql/configs/","title":"Конфигурирование postgresql"},{"content":"","href":"/tags/psql/","title":"psql"},{"content":"Работа с psql  Демо Слайды  Команды \\? список команд psql\n\\? variables переменные psql\n\\help показывает список команды, по которым можно получить документацию, например help alter table\n\\q выход\n\\conninfo информация о соединении\nYou are connected to database \u0026quot;postgres\u0026quot; as user \u0026quot;postgres\u0026quot; on host \u0026quot;127.0.0.1\u0026quot; at port \u0026quot;5432\u0026quot;. \\a включает/выключает выравнивание при выводе\n\\t включает/выключает вывод заголовков\n\\pset fielfsep ' ' устанавливает другой разделитель для строк, может использоваться для сохранения csv\n\\x расширенный вывод столбца\n\\set посмотреть список всех переменных\n\\set VAR1 text установка значения переменной\n\\echo :VAR1 вывод переменной\n\\d pg_tables показывает информацию о таблицах\nКонфигурационные файлы Общий конфигурационный файл pg_config --sysconfdir показывает директорию с настройками postgres\npg_config --sysconfdir /etc/postgresql В моём случае директория /etc/postgresql отсутствовала\nКонфигурационный файл конкретного пользователя Располагается в ~/.psqlrc\nПример файла от https://github.com/thoughtbot/dotfiles/blob/master/psqlrc\n-- Official docs: http://www.postgresql.org/docs/9.3/static/app-psql.html -- Unofficial docs: http://robots.thoughtbot.com/improving-the-command-line-postgres-experience -- Don't display the \u0026quot;helpful\u0026quot; message on startup. \\set QUIET 1 \\pset null '[NULL]' -- http://www.postgresql.org/docs/9.3/static/app-psql.html#APP-PSQL-PROMPTING \\set PROMPT1 '%[%033[1m%]%M %n@%/%R%[%033[0m%]%# ' -- PROMPT2 is printed when the prompt expects more input, like when you type -- SELECT * FROM\u0026lt;enter\u0026gt;. %R shows what type of input it expects. \\set PROMPT2 '[more] %R \u0026gt; ' -- Show how long each query takes to execute \\timing -- Use best available output format \\x auto \\set VERBOSITY verbose \\set HISTFILE ~/.psql_history- :DBNAME \\set HISTCONTROL ignoredups \\set COMP_KEYWORD_CASE upper \\unset QUIET Формат вывода С выравниванием (используется по умолчанию) 127.0.0.1 postgres@postgres=# SELECT schemaname, tablename, tableowner FROM pg_tables LIMIT 5; schemaname | tablename | tableowner ------------+-----------------+------------ pg_catalog | pg_statistic | postgres pg_catalog | pg_type | postgres pg_catalog | pg_policy | postgres pg_catalog | pg_authid | postgres pg_catalog | pg_user_mapping | postgres (5 rows) Без выравнивания \\a SELECT schemaname, tablename, tableowner FROM pg_tables LIMIT 5; schemaname|tablename|tableowner pg_catalog|pg_statistic|postgres pg_catalog|pg_type|postgres pg_catalog|pg_policy|postgres pg_catalog|pg_authid|postgres pg_catalog|pg_user_mapping|postgres (5 rows) Time: 1.400 ms Без заголовков \\t Tuples only is on. 127.0.0.1 postgres@postgres=# SELECT schemaname, tablename, tableowner FROM pg_tables LIMIT 5; pg_catalog|pg_statistic|postgres pg_catalog|pg_type|postgres pg_catalog|pg_policy|postgres pg_catalog|pg_authid|postgres pg_catalog|pg_user_mapping|postgres Time: 1.326 ms Расширенный(вертикальный вывод столбца) \\x Expanded display is on. 127.0.0.1 postgres@postgres=# SELECT * FROM pg_tables WHERE tablename = 'pg_class'; -[ RECORD 1 ]----------- schemaname | pg_catalog tablename | pg_class tableowner | postgres tablespace | [NULL] hasindexes | t hasrules | f hastriggers | f rowsecurity | f Time: 1.754 ms Взаимодействие с ОС  Можно выполнять команды обычного shell \\! whoami ixpectus  Установка переменной окружения =\u0026gt; \\setenv TEST Hello  Запись результатов вывода в файл \\o some_file 127.0.0.1 postgres@postgres=# SELECT * FROM pg_tables WHERE tablename = 'pg_class'; Time: 1.532 ms 127.0.0.1 postgres@postgres=# На экран ничего не выведется данные запишутся в файл. Можно поменять разделители и получить csv файл\n  Запуск скриптов  Как подготовить простой скрипт \\t Tuples only is off. 127.0.0.1 postgres@postgres=# \\a Output format is aligned. 127.0.0.1 postgres@postgres=# \\t \\a Tuples only is on. Output format is unaligned. 127.0.0.1 postgres@postgres=# \\o ~/tmp/psql_script1 127.0.0.1 postgres@postgres=# SELECT 'SELECT '''||tablename||': ''|| count(*) FROM '||tablename||';' FROM pg_tables LIMIT 3; Time: 1.119 ms  В результате в файле ~/tmp/psql_script1 окажется набор sql запросов SELECT 'pg_statistic: '|| count(*) FROM pg_statistic; SELECT 'pg_type: '|| count(*) FROM pg_type; SELECT 'pg_policy: '|| count(*) FROM pg_policy;  Выполнить их можно разными способами  \\i ~/tmp/psql_script1 в запущенном psql подав на вход psql файл   psql -h 127.0.0.1 -f ~/tmp/psql_script1 ?column? ------------------- pg_statistic: 393 (1 row) Time: 0.602 ms ?column? -------------- pg_type: 375 (1 row) Time: 0.212 ms ?column? -------------- pg_policy: 0 (1 row) Time: 0.220 ms Видно, что тут нет настроек \\t \\a и в заголовке выводится странная запись ?column?, можно в начале скрипта добавить \\t \\a \n подать файл на вход можно другим синтаксисом ``psql -h 127.0.0.1 \u0026lt; ~/tmp/psql_script1    Переменные  \\set посмотреть список всех переменных \\set VAR1 text установка значения переменной \\echo :VAR1 вывод переменной \\unset :VAR1 сбросить значение переменной SELECT now() AS curr_time \\gset можно результат запроса сразу установить в переменную \\echo :curr_time В переменную можно записать запрос и потом его выполнять \\set top5 'SELECT tablename, pg_total_relation_size(schemaname||''.''||tablename) AS bytes FROM pg_tables ORDER BY bytes DESC LIMIT 5;' :top5 Можно полезные запросы записывать в .psqlrc\n  ","href":"/posts/storage/postgresql/psql/","title":"psql"},{"content":"Установка из исходников  Где скачать Делаю по инструкции  Сам процесс установки tar -xzf postgresql-10.0.tar.gz cd ./postgresql-10.0.0 ./configure С версией 10.0.0 возникла ошибка при установке\ncopy_fetch.c:161:1: error: conflicting types for ‘copy_file_range’ copy_file_range(const char *path, off_t begin, off_t end, bool trunc) Взял версию 10.0.13. Всё установилось, но не был создан пользователь postgres, от имени которого должен запускаться сам postgres. Добавил его руками\nsudo useradd postgres sudo passwd postgres sudo mkdir /home/postgres sudo chown postgres /home/postgres su postgres Последним шагом вошёл в систему от имени пользователя postgres и добавил в .bashrc\nexport PGDATA=\u0026quot;/usr/local/psql/data\u0026quot; export PATH=$PATH:/usr/local/pgsql/bin/; Добавление psql директории для хранения данных sudo mkdir /usr/local/psql/ sudo chown postgres /usr/local/psql/ После добавление директории psql нужно выполнить от имени пользователя postgres initdb -k\nЗапуск сервера pg_ctl -w -l /home/postgres/logfile -D /usr/local/psql/data start Postgresql стартовал\nps aux | grep postgres ... postgres 102850 0.0 0.0 160184 2736 ? Ss 10:44 0:00 postgres: checkpointer process postgres 102851 0.0 0.0 160184 5004 ? Ss 10:44 0:00 postgres: writer process postgres 102852 0.0 0.0 160184 8516 ? Ss 10:44 0:00 postgres: wal writer process postgres 102853 0.0 0.0 160596 5804 ? Ss 10:44 0:00 postgres: autovacuum launcher process postgres 102854 0.0 0.0 15132 2644 ? Ss 10:44 0:00 postgres: stats collector process ... Но не удаётся подключится к нему\npsql psql: error: could not connect to server Попробовал скопировать конфиги и поменять listen_addresses\nsudo cp /usr/local/pgsql/share/postgresql.conf.sample /usr/local/pgsql/share/postgresql.conf Нужно было указать host\npsql -h 127.0.0.1 Установка расширения pgcrypto cd ./postgresql-10.13/contrib/pgcrypto make sudo make install Установка прошли успешно, проверяем установленные расширения\nselect * from pg_available_extensions; name | default_version | installed_version | comment ----------+-----------------+-------------------+------------------------------ plpgsql | 1.0 | 1.0 | PL/pgSQL procedural language pgcrypto | 1.3 | | cryptographic functions (2 rows) Установка всех расширений из директории contrib cd ./postgresql-10.13/contrib/ sudo make install name | default_version | installed_version | comment --------------------+-----------------+-------------------+---------------------------------------------------------------------- pg_prewarm | 1.1 | | prewarm relation data earthdistance | 1.1 | | calculate great-circle distances on the surface of the Earth tsm_system_time | 1.0 | | TABLESAMPLE method which accepts time in milliseconds as a limit plpgsql | 1.0 | 1.0 | PL/pgSQL procedural language pg_freespacemap | 1.2 | | examine the free space map (FSM) hstore | 1.4 | | data type for storing sets of (key, value) pairs pgstattuple | 1.5 | | show tuple-level statistics unaccent | 1.1 | | text search dictionary that removes accents chkpass | 1.0 | | data type for auto-encrypted passwords moddatetime | 1.0 | | functions for tracking last modification time tcn | 1.0 | | Triggered change notifications citext | 1.4 | | data type for case-insensitive character strings pageinspect | 1.6 | | inspect the contents of database pages at a low level tsm_system_rows | 1.0 | | TABLESAMPLE method which accepts number of rows as a limit amcheck | 1.0 | | functions for verifying relation integrity intagg | 1.1 | | integer aggregator and enumerator (obsolete) lo | 1.1 | | Large Object maintenance refint | 1.0 | | functions for implementing referential integrity (obsolete) btree_gist | 1.5 | | support for indexing common datatypes in GiST ltree ... Остановка сервера pg_ctl stop -m fast Можно написать просто pg_ctl stop, по умолчанию режим остановки как раз буде fast. Режимы остановки\n fast принудительно завершает все сеансы и записывает на диск изменения из оперативной памяти smart ожидает завершения всех сеансов и записывает на диск изменения из оперативной памяти immediate принудительно завершает сеансы, при запуске потребуется восстановление Получается immediate не записывает изменения из оперативной памяти, но не понятно какого рода восстановление понадобится после запуска  ","href":"/posts/storage/postgresql/install/","title":"Install"},{"content":"Хорошие курсы от команды postgrespro и Олега Бартунова\n Администрирование PostgreSQL 10. Базовый курс Администрирование PostgreSQL 9.5. Расширенный курс Разработка серверной части приложений PostgreSQL 9.6. Базовый курс  ","href":"/posts/storage/postgresql/courses/","title":"курсы по postgresql"},{"content":"ARP  Address resolution protocol В локальной сети по ip с помощью arp как-то определяется mac адрес и обращение идёт по нему  Call example sudo arp-scan 192.168.4.0/24 [sudo] пароль для ixpectus: Interface: enp3s0, datalink type: EN10MB (Ethernet) Starting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/) 192.168.4.1 00:19:bb:c5:3e:02 Hewlett-Packard Company 192.168.4.2 20:cf:30:f1:fd:58 ASUSTek COMPUTER INC. 192.168.4.6 00:30:48:62:5e:aa Supermicro Computer, Inc. 192.168.4.7 00:25:90:92:68:97 Super Micro Computer, Inc. 192.168.4.8 00:30:48:d4:1e:86 Supermicro Computer, Inc. 192.168.4.9 e8:40:f2:0c:2f:a5 PEGATRON CORPORATION 192.168.4.10 6c:62:6d:aa:3b:2e Micro-Star INT'L CO., LTD 192.168.4.11 52:54:00:94:1f:61 QEMU ","href":"/posts/administrate/networking/arp/","title":"arp"},{"content":"","href":"/tags/cli/","title":"cli"},{"content":"dd умеет читать побайтово с устройства\nflags  if откуда читать of куда писать bs сколько бит читать  example прочитает первые 512 бит диска /dev/sda\nsudo dd uf=/dev/sda bs=512 How to calculate read/write speed  dd if=/dev/zero of=~/test.tmp bs=500K count=1024 sync; echo 3 | sudo tee /proc/sys/vm/drop_caches reset cache dd if=~/test.tmp of=/dev/null bs=500K count=1024 write  ","href":"/posts/linux/tools/dd/","title":"dd"},{"content":"","href":"/tags/linux/","title":"linux"},{"content":"","href":"/tags/network/","title":"network"},{"content":"","href":"/posts/administrate/networking/","title":"networking"},{"content":"","href":"/","title":""},{"content":"","href":"/search/","title":""},{"content":"","href":"/authors/","title":"Authors"},{"content":"","href":"/categories/","title":"Categories"},{"content":"","href":"/page/","title":"Pages"},{"content":"","href":"/series/","title":"Series"}]
