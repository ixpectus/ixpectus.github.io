---
title: "Низкий уровень postrgesql"
date: 2020-07-10T18:12:28+03:00
tags:
  - postgresql
summary: "Представление данных в postgresql на уровне файлов и файловой системы"
---

* [Демо](https://edu.postgrespro.ru/dba1/dba1_10_data_lowlevel.html)
* [Слайды](https://edu.postgrespro.ru/dba1/dba1_10_data_lowlevel.pdf)

#### Файлы 
Каждый объект бд(таблица, индекс) может состоять из нескольких физических файлов, у postgres есть ограничение на размер одного файла - 1гб. Файлы одного объекта помещаются в один каталог

#### Страницы 
Файлы разделены на страницы(размер обычно 8кб)  
Каждая страница имеет внутреннюю разметку, содержит заголовок и полезные данные. Чтение с диска происходит по страницам, страницы помещаются сначала в буферный кэш и потом из него извлекаются

#### Toast таблицы 
Toast - the oversized attributes storage technique. Технология хранения длинных строк. Любая версия строки должна целиком помещаться на одну страницу. Для этого есть 2 подхода
* сжимать строки
* помещать в отдельную таблицу(pg_toast)
Версии строки в toast таблицы тоже должны помещаться на одну страницу, поэтому postgres может делить их на части, и потом прозрачно склеивать для пользователя  
Обращение к toast таблице идёт в случае, если запрашивается длинное значение

#### Слои
##### Основой
Содержит данные(версии строк)
##### Карта свободного пространства(fsm) 
В ней отмечено наличие пустых мест внутри страниц. Используется при вставке новых версий строк, чтобы быстро найти подходящую страницу для вставки
##### Карта видимости(vm) 
Отмечает страницы, на которых все версии строк видны во всех снимках. В карте видимости хранятся страницы, которые давно не изменялись и успели полностью очиститься от неактуальных версий.  
* Используется для оптимизации процесса очистки 
* Для ускорения индексного доступа, из индекса получаем ссылку на версию строки, и нужно проверить её видимость, для этого нужно прочитать страницу с данными. Если в самом индексе есть все нужные столбцы и страница помечена в карте видимости, то дополнительные данные можно не извлекать
* Появляется после того, как сделать `VACUUM`


#### Практика 
* Как посмотреть имя файла для таблицы относительно PGDATA, где t - таблица
  ```
  postgres@127:data_lowlevel> select pg_relation_filepath('t');
  +------------------------+
  | pg_relation_filepath   |
  |------------------------|
  | base/24642/24645       |
  +------------------------+
  SELECT 1
  ```
  В директории `/usr/local/psql/data/base/24642` лежат 2 файла 24645, 24645_fsm
* Директорию базы данных можно узнать так 
  ```
    postgres@127:data_lowlevel> SELECT OID FROM pg_database WHERE datname = 'data_lowlevel';
  +-------+
  | oid   |
  |-------|
  | 24642 |
  +-------+
  ```
  Имя директории соответствует oid базы
* Отдельно имя файла для таблицы можно узнать так
  ```
    postgres@127:data_lowlevel> SELECT relfilenode FROM pg_class WHERE relname = 't';
  +---------------+
  | relfilenode   |
  |---------------|
  | 24645         |
  +---------------+
  SELECT 1
  ```
* Как посмотреть размер каждого слоя
  ```
  SELECT pg_size_pretty(pg_relation_size('t','main')) main,
  pg_size_pretty(pg_relation_size('t','fsm')) fsm,
  pg_size_pretty(pg_relation_size('t','vm')) vm;
  ```
* Как посмотреть размер таблицы
  ```
  SELECT pg_table_size('t');
  ```
* Как посмотреть размер индекса
  ```
  SELECT pg_indexes_size('t');
  ```
* Как посмотреть размер всей таблицы
  ```
  SELECT pg_total_relation_size('t');
  ```

##### Toast 
* Как узнать используется ли toast для хранения колонки или нет
  ```
  \d+ t
  ```
  Если в колонке storage указано extended, то используется
  * plain - TOAST не применяется (тип имеет фиксированную длину);
  * main - приоритет сжатия;
  * extended - применяется как сжатие, так и отдельное хранение;
  * external - только отдельно хранение без сжатия.

